{% extends "core/base.html" %}
{% load static %}

{% block title %}Search Restaurants{% endblock %}

{% extends "core/base.html" %}
{% load static %}

{% block title %}Search Restaurants - RestaurantAI{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Page Header -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="text-gradient mb-3">Find Your Perfect Restaurant</h1>
            <p class="text-muted lead">Discover amazing dining experiences with our intelligent search and filtering system</p>
        </div>
    </div>

    <div class="row">
        <!-- Search Filters Sidebar -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-custom sticky-top" style="top: 100px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Search Filters
                    </h5>
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="mb-4">
                            <label for="location" class="form-label fw-bold">
                                <i class="bi bi-geo-alt text-primary me-1"></i>Location
                            </label>
                            <input type="text" class="form-control form-control-lg" id="location" name="location" placeholder="Enter city or area">
                        </div>

                        <div class="mb-4">
                            <label for="cuisine" class="form-label fw-bold">
                                <i class="bi bi-cup-hot text-primary me-1"></i>Cuisine Type
                            </label>
                            <select class="form-select form-select-lg" id="cuisine" name="cuisine">
                                <option value="">All Cuisines</option>
                                <option value="Italian">üçù Italian</option>
                                <option value="Chinese">ü•¢ Chinese</option>
                                <option value="Mexican">üåÆ Mexican</option>
                                <option value="Indian">üçõ Indian</option>
                                <option value="Japanese">üç± Japanese</option>
                                <option value="American">üçî American</option>
                                <option value="French">ü•ñ French</option>
                                <option value="Thai">üçú Thai</option>
                                <option value="Mediterranean">ü´í Mediterranean</option>
                                <option value="Korean">üç≤ Korean</option>
                                <option value="Vietnamese">ü•ò Vietnamese</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="price" class="form-label fw-bold">
                                <i class="bi bi-cash text-primary me-1"></i>Price Range
                            </label>
                            <select class="form-select form-select-lg" id="price" name="price">
                                <option value="">Any Price</option>
                                <option value="$">$ - Budget Friendly</option>
                                <option value="$$">$$ - Moderate</option>
                                <option value="$$$">$$$ - Upscale</option>
                                <option value="$$$$">$$$$ - Fine Dining</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-heart text-primary me-1"></i>Dietary Options
                            </label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="dietary[]" value="Vegetarian" id="vegetarian">
                                <label class="form-check-label" for="vegetarian">
                                    <i class="bi bi-leaf text-success me-1"></i>Vegetarian
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="dietary[]" value="Vegan" id="vegan">
                                <label class="form-check-label" for="vegan">
                                    <i class="bi bi-tree text-success me-1"></i>Vegan
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="dietary[]" value="Gluten-free" id="gluten-free">
                                <label class="form-check-label" for="gluten-free">
                                    <i class="bi bi-shield-check text-info me-1"></i>Gluten-free
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="rating_min" class="form-label fw-bold">
                                <i class="bi bi-star text-warning me-1"></i>Minimum Rating
                            </label>
                            <select class="form-select form-select-lg" id="rating_min" name="rating_min">
                                <option value="">Any Rating</option>
                                <option value="3">‚≠ê 3+ Stars</option>
                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4+ Stars</option>
                                <option value="4.5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 4.5+ Stars</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="order_by" class="form-label fw-bold">
                                <i class="bi bi-sort-down text-primary me-1"></i>Sort By
                            </label>
                            <select class="form-select form-select-lg" id="order_by" name="order_by">
                                <option value="rating">Highest Rated</option>
                                <option value="price">Price (Low to High)</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="distance">Distance</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-search me-2"></i>Search Restaurants
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearFilters">
                                <i class="bi bi-x-circle me-2"></i>Clear Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="col-lg-8">
            <!-- Search Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">Search Results</h2>
                    <p class="text-muted mb-0" id="resultsCount">Showing 0 restaurants</p>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" id="gridView">
                        <i class="bi bi-grid"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="listView">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center py-5 d-none">
                <div class="spinner mb-3"></div>
                <p class="text-muted">Searching for restaurants...</p>
            </div>

            <!-- Results Container -->
            <div id="resultsContainer" class="row g-4">
                <!-- Results will be loaded here dynamically -->
            </div>

            <!-- No Results -->
            <div id="noResults" class="text-center py-5 d-none">
                <div class="mb-4">
                    <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                </div>
                <h4 class="text-muted mb-3">No restaurants found</h4>
                <p class="text-muted mb-4">Try adjusting your search criteria or browse all restaurants.</p>
                <a href="{% url 'core:home' %}" class="btn btn-primary">
                    <i class="bi bi-house me-2"></i>Browse All Restaurants
                </a>
            </div>

            <!-- Pagination -->
            <nav id="paginationNav" class="mt-5 d-none">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be loaded here -->
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}
                                <option value="-rating">Highest Rated</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="-name">Name (Z-A)</option>
                                <option value="price_range">Price (Low to High)</option>
                                <option value="-price_range">Price (High to Low)</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Search Results -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between mb-3">
                <h3>Results <span id="resultCount" class="badge bg-secondary">0</span></h3>
                <div id="loadingSpinner" class="spinner-border text-primary d-none" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            
            <div id="searchResults" class="row">
                <!-- Results will be inserted here via JavaScript -->
                <div class="col-12 text-center py-5">
                    <p class="text-muted">Use the filters to find restaurants</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Search form submission
        $('#searchForm').on('submit', function(e) {
            e.preventDefault();
            
            // Show loading spinner
            $('#loadingSpinner').removeClass('d-none');
            
            // Get form data
            const formData = $(this).serialize();
            
            // Make AJAX request
            $.ajax({
                url: "{% url 'core:restaurant_search' %}",
                type: "GET",
                data: formData,
                success: function(response) {
                    // Hide loading spinner
                    $('#loadingSpinner').addClass('d-none');
                    
                    // Update result count
                    $('#resultCount').text(response.results.length);
                    
                    // Clear previous results
                    $('#searchResults').empty();
                    
                    if (response.results.length === 0) {
                        $('#searchResults').html(
                            '<div class="col-12 text-center py-5">' +
                            '<p class="text-muted">No restaurants found matching your criteria.</p>' +
                            '</div>'
                        );
                        return;
                    }
                    
                    // Display results
                    response.results.forEach(function(restaurant) {
                        let priceDisplay = '';
                        for (let i = 0; i < restaurant.price_range.length; i++) {
                            priceDisplay += '$';
                        }
                        
                        $('#searchResults').append(`
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="row g-0">
                                        <div class="col-md-4">
                                            <img src="${restaurant.image_url || '/static/core/img/default_restaurant.jpg'}" 
                                                class="img-fluid rounded-start h-100 w-100" 
                                                alt="${restaurant.name}" 
                                                style="object-fit: cover;">
                                        </div>
                                        <div class="col-md-8">
                                            <div class="card-body">
                                                <h5 class="card-title">${restaurant.name}</h5>
                                                <p class="card-text">
                                                    <span class="badge bg-info">${restaurant.cuisine_type}</span>
                                                    <span class="badge bg-secondary">${priceDisplay}</span>
                                                </p>
                                                <p class="card-text">
                                                    <i class="bi bi-star-fill text-warning"></i> 
                                                    <strong>${restaurant.rating}</strong>/5
                                                </p>
                                                <p class="card-text small text-muted">${restaurant.address}</p>
                                                <a href="/restaurant/${restaurant.id}/" class="btn btn-outline-primary btn-sm">View Details</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                },
                error: function(error) {
                    // Hide loading spinner
                    $('#loadingSpinner').addClass('d-none');
                    
                    // Show error message
                    $('#searchResults').html(
                        '<div class="col-12 text-center py-5">' +
                        '<div class="alert alert-danger" role="alert">' +
                        'Error loading restaurants. Please try again.' +
                        '</div>' +
                        '</div>'
                    );
                    console.error(error);
                }
            });
        });
        
        // Trigger a search when the page loads with default values
        if (window.location.search) {
            // If there are URL parameters, the form will be auto-populated
            // and we should trigger a search
            setTimeout(function() {
                $('#searchForm').submit();
            }, 500);
        }
    });
</script>
{% endblock %}
